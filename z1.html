<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cennik Por贸wnawczy</title>
  <style>
    :root {
      --color-background: var(--color-cream-50, #fcfcf9);
      --color-surface: var(--color-cream-100, #fffffd);
      --color-text: var(--color-slate-900, #13343b);
      --color-text-secondary: var(--color-slate-500, #626c71);
      --color-primary: var(--color-teal-500, #21808d);
      --color-primary-hover: var(--color-teal-600, #1d7480);
      --color-border: rgba(94,82,64,0.2);
      --radius: 10px;
      --shadow: 0 1px 4px 0 rgba(0,0,0,0.07);
      --font: "Inter", "Geist", Arial, sans-serif;
      --space: 18px;
      --space-sm: 10px;
      --space-xs: 6px;
      --max-width: 1100px;
      --mobile-break: 600px;
      --tab-bg: var(--color-surface);
      --tab-border: var(--color-border);
      --tab-active: var(--color-primary);
    }

    /* Login overlay styles */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    }

    .login-box {
      background: var(--color-surface);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .login-box h2 {
      color: var(--color-text);
      margin-bottom: 30px;
      font-size: 1.8em;
    }

    .login-box input {
      width: 100%;
      padding: 15px;
      margin-bottom: 20px;
      border: 2px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 1.1em;
      box-sizing: border-box;
      background: var(--color-background);
    }

    .login-box input:focus {
      border-color: var(--color-primary);
      outline: none;
    }

    .login-btn {
      width: 100%;
      padding: 15px;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .login-btn:hover {
      background: var(--color-primary-hover);
    }

    .login-error {
      color: #d1002a;
      margin-top: 10px;
      font-size: 0.9em;
      display: none;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--color-background);
      color: var(--color-text);
      font-family: var(--font);
      font-size: 16px;
      min-height: 100vh;
    }

    .container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--space);
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid var(--tab-border);
      background: var(--tab-bg);
      border-radius: var(--radius) var(--radius) 0 0;
      margin-bottom: var(--space);
      overflow-x: auto;
      align-items: center;
      gap: 4px;
    }

    .tab {
      padding: var(--space-sm) var(--space);
      cursor: pointer;
      color: var(--color-text-secondary);
      border: none;
      border-bottom: 4px solid transparent;
      background: none;
      font-size: 1.1em;
      outline: none;
      transition: border-bottom 0.2s, color 0.2s, background 0.2s;
      margin-right: 2px;
      flex-shrink: 0;
    }

    .tab.active {
      color: var(--tab-active);
      border-bottom: 4px solid var(--tab-active);
      font-weight: 600;
      background: var(--color-surface);
    }

    /* Logout button styl */
    #logout-btn {
      margin-left: auto;
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background: #f5f5f5;
      font-size: 0.95em;
      padding: 6px 16px;
    }
    #logout-btn:hover {
      background: #e4e4e4;
    }

    @media(max-width: 600px) {
      .container {
        max-width: 100vw;
        padding: var(--space-sm);
      }
      .tabs {
        font-size: 0.95em;
      }
      .tab {
        padding: var(--space-xs) var(--space-sm);
      }
      .products-table th, .products-table td {
        padding: var(--space-xs) var(--space-xs);
        font-size: 0.9em;
      }
    }

    .products-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--color-surface);
      box-shadow: var(--shadow);
      margin-bottom: var(--space);
    }
    .products-table th, .products-table td {
      padding: var(--space-sm) var(--space);
      border: 1px solid var(--color-border);
      text-align: left;
      vertical-align: middle;
    }
    .products-table th {
      background: var(--color-surface);
    }
    .products-table tr.lowest td {
      font-weight: bold;
      background: rgba(33,128,141,0.12);
      color: var(--color-primary);
    }
    .products-table td.lowest {
      font-weight: bold;
      background: rgba(33,128,141,0.17);
      color: var(--color-primary);
    }

    .products-table th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .products-table th.sortable:hover {
      background: rgba(33,128,141,0.08);
    }

    .products-table th.sortable::after {
      content: '';
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      margin-left: 5px;
      display: inline-block;
      opacity: 0.5;
    }

    .products-table th.sortable.sort-asc::after {
      border-top: 7px solid var(--color-primary);
      opacity: 1;
    }

    .products-table th.sortable.sort-desc::after {
      border-bottom: 7px solid var(--color-primary);
      opacity: 1;
    }

    .products-table td input,
    .products-table td select {
      width: 100%;
      box-sizing: border-box;
    }

    .add-section, .compare-section {
      background: var(--color-surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: var(--space);
      padding: var(--space-sm) var(--space);
    }
    label {
      font-weight: 500;
      display: block;
      margin-bottom: 6px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space);
      margin-bottom: var(--space);
    }
    .row > * {
      flex: 1;
      min-width: 160px;
    }
    input, select, button {
      font-family: inherit;
      font-size: 1em;
      padding: 7px 13px;
      border-radius: var(--radius);
      border: 1px solid var(--color-border);
      margin-bottom: 5px;
      background: var(--color-surface);
      outline: none;
      transition: border-color .2s;
    }
    input:focus, select:focus {
      border-color: var(--color-primary);
    }
    button.primary {
      background: var(--color-primary);
      color: #fff;
      border: none;
      cursor: pointer;
      margin-right: 10px;
      min-width: 80px;
      font-weight: 500;
      transition: background .2s;
    }
    button.primary:hover, button.primary:focus {
      background: var(--color-primary-hover);
    }
    button.secondary {
      background: var(--color-surface);
      color: var(--color-primary);
      border: 1px solid var(--color-primary);
      cursor: pointer;
      font-weight: 400;
    }

    @media(max-width: 480px) {
      .row {
        flex-direction: column;
        gap: var(--space-xs);
      }
      .products-table {
        font-size: 0.92em;
      }
    }

    .section-title {
      margin-top: 0;
      color: var(--color-primary);
      font-size: 1.32em;
      border-left: 5px solid var(--color-primary);
      padding-left: 16px;
      margin-bottom: var(--space-sm);
    }
    .info {
      color: var(--color-text-secondary);
      font-size: 1em;
      margin-bottom: var(--space-xs);
      margin-top: -10px;
    }
    .remove-btn {
      color: #fff;
      background: #ff5555;
      border: none;
      border-radius: var(--radius);
      padding: 4px 10px;
      font-size: 0.8em;
      cursor: pointer;
      margin-left: 7px;
      margin-bottom: 3px;
    }
    .remove-btn:hover {
      background: #d1002a;
    }
    .company-card {
      margin-bottom: 16px;
    }
    .company-card__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .company-card__header:hover {
      background: rgba(33,128,141,0.05);
    }
    .company-card__toggle {
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: 6px 14px;
      font-size: 0.9em;
      cursor: pointer;
      font-weight: 500;
      transition: background .2s;
    }
    .company-card__toggle:hover {
      background: var(--color-primary-hover);
    }
    .company-card__body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .company-card__body.expanded {
      max-height: 2000px;
    }

    .editable-price {
      cursor: pointer;
    }
    .editable-price:hover {
      background: rgba(33,128,141,0.08);
    }

    .products-search {
      margin-bottom: 12px;
    }

    .products-search-clear-btn {
      flex: 0 0 auto;
      flex-shrink: 0;
      padding: 7px 10px;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 0;
      height: 100%;
      box-sizing: border-box;
      margin-left: 32px;
    }
    .products-search-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
      max-width: 420px;
    }

    /* nieprzezroczyste pole szukania */
    #products-search-input {
      background-color: #ffffff;
      color: var(--color-text);
    }
  </style>
</head>
<body>
  <!-- Login overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2> Logowanie</h2>
      <input type="password" id="loginPassword" placeholder="Wpisz haso..." autocomplete="off" />
      <button class="login-btn" id="loginBtn">Zaloguj</button>
      <div class="login-error" id="loginError">Nieprawidowe haso!</div>
    </div>
  </div>

  <div class="container" id="app" style="display: none;">
    <nav class="tabs" role="tablist">
      <button id="tab-products" class="tab active" data-tab="products" role="tab" aria-selected="true">Produkty</button>
      <button id="tab-companies" class="tab" data-tab="companies" role="tab">Firmy</button>
      <button id="logout-btn" class="tab" type="button">Wyloguj</button>
    </nav>

    <main>
      <section id="products-section">
        <h2 class="section-title">Lista produkt贸w i por贸wnanie cen</h2>
        <div class="compare-section" id="compare-products"></div>
      </section>

      <section id="companies-section" style="display: none;">
        <h2 class="section-title">Lista firm i ich cenniki</h2>
        <div class="add-section">
          <form id="add-company-form" autocomplete="off">
            <div class="row">
              <div style="flex: 2; min-width: 200px;">
                <label for="new-company-input">Nazwa firmy</label>
                <input type="text" id="new-company-input" placeholder="Wpisz nazw firmy..." required />
              </div>
              <div style="flex: 1; min-width: 100px; display: flex; align-items: flex-end;">
                <button type="submit" class="primary">Dodaj firm</button>
              </div>
            </div>
            <div class="info" id="add-company-message"></div>
          </form>
        </div>
        <div class="compare-section" id="compare-companies"></div>
      </section>
    </main>
  </div>

  <script>
    // KONFIGURACJA HASA - ZMIE NA SWOJE!
    const PASSWORD = "cennik2025";

    // Login elements
    const loginOverlay = document.getElementById('loginOverlay');
    const loginPassword = document.getElementById('loginPassword');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const app = document.getElementById('app');
    const logoutBtn = document.getElementById('logout-btn');

    loginBtn.onclick = () => {
      const enteredPassword = loginPassword.value.trim();
      if (enteredPassword === PASSWORD) {
        loginOverlay.style.display = 'none';
        app.style.display = 'block';
        loginPassword.value = '';
        renderAll(); // Initialize app
      } else {
        loginError.style.display = 'block';
        loginPassword.value = '';
        loginPassword.focus();
        setTimeout(() => {
          loginError.style.display = 'none';
        }, 3000);
      }
    };

    loginPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        loginBtn.click();
      }
    });

    // logout
    logoutBtn.onclick = () => {
      app.style.display = 'none';
      loginOverlay.style.display = 'flex';
      loginPassword.value = '';
      loginPassword.focus();
    };

    // Prevent app access without login via Enter
    document.addEventListener('keydown', (e) => {
      if (loginOverlay.style.display !== 'none' && e.key === 'Enter') {
        loginBtn.click();
      }
    });

    // Reszta kodu aplikacji
    const exampleProducts = [
      "Mleko 2% 1L", "Chleb wiejski", "Maso 200g", "Ser 偶贸ty 150g", "Jajka 10szt", "Szynka 100g", "Sok pomaraczowy 1L", "Makaron 500g", "Mka pszenna 1kg", "Czekolada mleczna 100g",
      "Kawa mielona 250g", "Herbata czarna 100g", "Oliwa 500ml", "Jogurt naturalny 400g", "Pomidor luz", "Og贸rek wie偶y", "Ziemniaki 1kg", "Ry偶 biay 1kg", "Cukier 1kg", "Woda mineralna 1.5L",
      "Piwo 0.5L", "Filet z kurczaka 1kg", "Twar贸g p贸tusty", "Saata lodowa", "oso wdzony 100g", "Banany 1kg", "Jabko 1kg", "Salami 100g", "Szpinak wie偶y", "Brzoskwinie1 1kg"
    ].slice(0, 30);

    const exampleCompanies = [
      "Biedronka", "Lidl", "Carrefour", "Auchan", "Kaufland", "Netto", "呕abka", "Tesco", "Stokrotka", "Dino"
    ];

    function randPrice(min, max) {
      let v = (Math.random() * (max - min) + min).toFixed(2);
      return Number(v);
    }

    function buildExamplePrices(){
      const prices = [];
      for(let company of exampleCompanies) {
        let productList = [...exampleProducts];
        for(let i = 0; i < 7 + Math.floor(Math.random()*10); i++) {
          let idx = Math.floor(Math.random()*productList.length);
          const product = productList.splice(idx, 1)[0];
          prices.push({
            company,
            product,
            price: randPrice(2, 13)
          });
        }
      }
      return prices;
    }

    let products = [...exampleProducts];
    let companies = [...exampleCompanies];
    let priceList = buildExamplePrices();
    let expandedCompanies = new Set();

    let productSortColumn = 0;
    let productSortAsc = true;
    let productFilterText = "";

    const tabProducts = document.getElementById('tab-products');
    const tabCompanies = document.getElementById('tab-companies');
    const sectionProducts = document.getElementById('products-section');
    const sectionCompanies = document.getElementById('companies-section');
    const compareProducts = document.getElementById('compare-products');
    const compareCompanies = document.getElementById('compare-companies');
    const addCompanyForm = document.getElementById('add-company-form');
    const addCompanyInput = document.getElementById('new-company-input');
    const addCompanyMessage = document.getElementById('add-company-message');

    function showTab(key) {
      [tabProducts, tabCompanies].forEach(tab => tab.classList.remove('active'));
      sectionProducts.style.display = sectionCompanies.style.display = 'none';
      switch(key) {
        case 'products':
          tabProducts.classList.add('active');
          sectionProducts.style.display = '';
          break;
        case 'companies':
          tabCompanies.classList.add('active');
          sectionCompanies.style.display = '';
          break;
      }
    }
    tabProducts.onclick = () => showTab('products');
    tabCompanies.onclick = () => showTab('companies');

    addCompanyForm.onsubmit = function(evt){
      evt.preventDefault();
      let compName = addCompanyInput.value.trim();
      if (!compName) {
        setAddCompanyMsg("Prosz wpisa nazw firmy.", true);
        return;
      }
      if (companies.includes(compName)) {
        setAddCompanyMsg("Taka firma ju偶 istnieje.", true);
        return;
      }
      companies.push(compName);
      setAddCompanyMsg("Dodano now firm!", false);
      renderAll();
      addCompanyForm.reset();
      setTimeout(()=>setAddCompanyMsg("", false), 1300);
    };

    function setAddCompanyMsg(msg, error) {
      addCompanyMessage.textContent = msg;
      addCompanyMessage.style.color = error ? "#d1002a" : "var(--color-primary)";
    }

    function getMinPriceForCompanyProduct(company, product) {
      const entries = priceList.filter(
        x => x.company === company && x.product === product
      );
      if (!entries.length) return null;
      return entries.reduce((min, e) =>
        e.price < min ? e.price : min
      , entries[0].price);
    }

    function renderAll() {
      renderProductsTable();
      renderCompaniesTable();
    }

    function applyProductsFilter() {
      const filterLower = productFilterText.trim().toLowerCase();
      const rows = compareProducts.querySelectorAll("table.products-table tbody tr");
      rows.forEach(row => {
        const nameCell = row.querySelector("td:first-child");
        if (!nameCell) return;
        const text = nameCell.textContent.toLowerCase();
        if (!filterLower) {
          row.style.display = "";
        } else {
          row.style.display = text.includes(filterLower) ? "" : "none";
        }
      });
    }

    function renderProductsTable() {
      let html = `
        <div class="products-search">
         <label for="products-search-input">Szukaj produktu:</label>
         <div class="products-search-wrapper">
           <div style="position:relative;flex:1;min-width:0;">
             <input
               id="products-search-input"
               type="text"
               placeholder="Wpisz nazw produktu..."
               value="${productFilterText.replace(/"/g, '&quot;')}"
               autocomplete="off"
               style="width:100%;"
             />
             <div
               id="products-suggestions"
               style="position:absolute;top:100%;left:0;right:0;background:var(--color-surface);border:1px solid var(--color-border);border-radius:8px;margin-top:2px;max-height:160px;overflow-y:auto;z-index:10;font-size:0.9em;display:none;"
             ></div>
           </div>
           <button
             type="button"
             id="products-search-clear"
             class="secondary products-search-clear-btn"
           >
             <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
               <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
               <line x1="8" y1="8" x2="16" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
               <line x1="16" y1="8" x2="8" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
             </svg>
           </button>
         </div>
        </div>
      `;
      html += '<div class="info">Por贸wnaj ceny wszystkich produkt贸w we wszystkich firmach. Najtasza oferta jest pogrubiona i podwietlona. Kliknij nag贸wki kolumn aby sortowa.</div>';
      html += `<table class="products-table"><thead><tr>`;

      const productClass = productSortColumn === 0 ? (productSortAsc ? 'sort-asc' : 'sort-desc') : '';
      html += `<th data-col="0" class="sortable ${productClass}">Produkt</th>`;

      for (let i = 0; i < companies.length; i++) {
        const colIndex = i + 1;
        const companyClass = productSortColumn === colIndex ? (productSortAsc ? 'sort-asc' : 'sort-desc') : '';
        html += `<th data-col="${colIndex}" class="sortable ${companyClass}">${companies[i]}</th>`;
      }
      html += `</tr></thead><tbody>`;

      let sortedProducts = [...products];
      sortedProducts.sort((a, b) => {
        if (productSortColumn === 0) {
          return productSortAsc
            ? a.toLowerCase().localeCompare(b.toLowerCase())
            : b.toLowerCase().localeCompare(a.toLowerCase());
        } else {
          const companyIndex = productSortColumn - 1;
          const company = companies[companyIndex];
          const minA = getMinPriceForCompanyProduct(company, a);
          const minB = getMinPriceForCompanyProduct(company, b);
          const priceA = (minA !== null) ? minA : Infinity;
          const priceB = (minB !== null) ? minB : Infinity;
          return productSortAsc ? priceA - priceB : priceB - priceA;
        }
      });

      for (const prod of sortedProducts) {
        let row = [];
        for (const comp of companies) {
          const minPrice = getMinPriceForCompanyProduct(comp, prod);
          row.push(minPrice !== null ? minPrice.toFixed(2) : "");
        }
        const nrw = row.filter(v => v !== "" && !isNaN(Number(v)));
        const minVal = nrw.length ? Math.min(...nrw.map(Number)) : null;

        html += `<tr>`;
        html += `<td>${prod}</td>`;
        for (let i = 0; i < row.length; i++) {
          const val = row[i];
          if (val !== "" && Number(val) === minVal) {
            html += `<td class="lowest">${val} z</td>`;
            } else {
            html += `<td>${val !== "" ? val + ' z' : "-"}</td>`;
          }
        }
        html += `</tr>`;
      }

      html += `</tbody></table>`;
      compareProducts.innerHTML = html;

      const searchInput = document.getElementById('products-search-input');
      const suggestionsBox = document.getElementById('products-suggestions');
      const clearBtn = document.getElementById('products-search-clear');

      function updateSuggestions() {
        const text = searchInput.value.trim().toLowerCase();
        productFilterText = text;

        if (!text) {
          suggestionsBox.style.display = 'none';
          applyProductsFilter();
          return;
        }

        const suggestions = products
          .filter(p => p.toLowerCase().includes(text))
          .slice(0, 8);

        if (!suggestions.length) {
          suggestionsBox.style.display = 'none';
        } else {
          suggestionsBox.innerHTML = suggestions
            .map(p => `<div data-value="${p.replace(/"/g, '&quot;')}" style="padding:6px 10px;cursor:pointer;">${p}</div>`)
            .join('');
          suggestionsBox.style.display = 'block';

          suggestionsBox.querySelectorAll('div[data-value]').forEach(item => {
            item.onclick = () => {
              const val = item.getAttribute('data-value');
              searchInput.value = val;
              productFilterText = val.toLowerCase();
              suggestionsBox.style.display = 'none';
              applyProductsFilter();
            };
          });
        }

        applyProductsFilter();
      }

      searchInput.addEventListener('input', updateSuggestions);
      searchInput.addEventListener('focus', updateSuggestions);
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.products-search')) {
          suggestionsBox.style.display = 'none';
        }
      });

      clearBtn.addEventListener('click', () => {
        productFilterText = "";
        searchInput.value = "";
        suggestionsBox.style.display = "none";
        applyProductsFilter();
        searchInput.focus();
      });

      compareProducts.querySelectorAll('th.sortable').forEach(th => {
        th.onclick = () => {
          const col = Number(th.dataset.col);
          if (productSortColumn === col) {
            productSortAsc = !productSortAsc;
          } else {
            productSortColumn = col;
            productSortAsc = true;
          }
          renderProductsTable();
        };
      });

      applyProductsFilter();
    }

    function renderCompaniesTable() {
      let html = '<div class="info">Kliknij na cen, aby j edytowa. Mo偶esz te偶 usuwa ceny, firmy i produkty. Dodatkowa kolumna pokazuje najni偶sz cen danego produktu we wszystkich firmach.</div>';
      const sortedCompanies = [...companies].sort();
      for (const company of sortedCompanies) {
        html += `<div class="company-card">
          <div class="company-card__header">
            <span style="font-size:1.08em;font-weight:500;flex:1;">${company}</span>
            <button class="company-card__toggle" data-company="${company}">Rozwi cennik</button>
            <button class="remove-btn" data-company="${company}">Usu firm</button>
          </div>
          <div class="company-card__body">
            <table class="products-table" style="margin-bottom:0;">
              <thead>
                <tr>
                  <th>Produkt</th>
                  <th>Cena w tej firmie</th>
                  <th>Najtasza cena produktu</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>`;

        let entries = priceList.filter(p => p.company === company);
        entries.sort((a, b) =>
          a.product.toLowerCase().localeCompare(b.product.toLowerCase())
        );

        if(entries.length === 0) {
          html += `<tr><td colspan="4"><em>Brak cen dla tej firmy</em></td></tr>`;
        } else {
          for (const p of entries) {
            const currentPrice = Number(p.price).toFixed(2);
            const allForProduct = priceList.filter(x => x.product === p.product);
            const minForProduct = allForProduct.length
              ? Math.min(...allForProduct.map(x => Number(x.price)))
              : null;

            let minForProductStr = '-';
            if (minForProduct !== null) {
              const cheapestEntry = allForProduct.find(x => Number(x.price) === minForProduct);
              const cheapestCompany = cheapestEntry ? cheapestEntry.company : '?';
              minForProductStr = `${minForProduct.toFixed(2)} z (${cheapestCompany})`;
            }

            html += `<tr>
              <td>${p.product}</td>
              <td class="editable-price" data-company="${company}" data-product="${p.product}">${currentPrice} z</td>
              <td>${minForProductStr}</td>
              <td><button class="remove-btn" data-company="${company}" data-product="${p.product}">Usu</button></td>
            </tr>`;
          }
        }

        html += `</tbody></table>
            <div style="margin-top:12px;">
              <button class="company-card__toggle" data-add-product="${company}" style="background:#4caf50;padding:8px 16px;font-size:0.9em;">+ Nowy produkt</button>
            </div>
          </div>
        </div>`;
      }

      compareCompanies.innerHTML = html;

      compareCompanies.querySelectorAll('.company-card').forEach(card => {
        const headerSpan = card.querySelector('.company-card__header span');
        if (!headerSpan) return;
        const name = headerSpan.textContent.trim();
        const body = card.querySelector('.company-card__body');
        const toggleBtn = card.querySelector('button.company-card__toggle[data-company]');
        if (expandedCompanies.has(name)) {
          body.classList.add('expanded');
          if (toggleBtn) toggleBtn.textContent = 'Zwi cennik';
        }
      });

      compareCompanies.querySelectorAll("button.remove-btn").forEach(btn => {
        if (btn.dataset.product && btn.dataset.company) {
          btn.onclick = ()=>{
            removePrice(btn.dataset.company, btn.dataset.product);
          };
        } else if (btn.dataset.company) {
          btn.onclick = ()=> {
            if (confirm("Usun firm oraz jej wszystkie ceny?")) removeCompany(btn.dataset.company);
          };
        }
      });

      compareCompanies.querySelectorAll("td.editable-price").forEach(td => {
        td.onclick = () => {
          const company = td.dataset.company;
          const product = td.dataset.product;

          const entryIndex = priceList.findIndex(p => p.company === company && p.product === product);
          if (entryIndex === -1) return;

          const oldPrice = priceList[entryIndex].price;

          td.innerHTML = "";
          const input = document.createElement("input");
          input.type = "number";
          input.min = "0.01";
          input.step = "0.01";
          input.value = oldPrice.toFixed(2);
          input.style.width = "100%";
          td.appendChild(input);
          input.focus();
          input.select();

          const cancelEdit = () => {
            td.textContent = oldPrice.toFixed(2) + " z";
          };

          input.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              cancelEdit();
            }
            if (e.key === "Enter") {
              const val = input.value.trim();
              const num = Number(val);
              if (!val || isNaN(num) || num <= 0) {
                cancelEdit();
                return;
              }
              priceList[entryIndex].price = Number(num.toFixed(2));
              renderAll();
            }
          });

          input.addEventListener("blur", () => {
            const val = input.value.trim();
            const num = Number(val);
            if (!val || isNaN(num) || num <= 0) {
              cancelEdit();
            } else {
              priceList[entryIndex].price = Number(num.toFixed(2));
              renderAll();
            }
          });
        };
      });

      compareCompanies.querySelectorAll(".company-card").forEach(card => {
        const header = card.querySelector(".company-card__header");
        const toggleBtn = header.querySelector("button.company-card__toggle[data-company]");
        const addProductBtn = card.querySelector("button.company-card__toggle[data-add-product]");

        if (addProductBtn) {
          addProductBtn.onclick = (e)=>{
            e.stopPropagation();
            const company = addProductBtn.dataset.addProduct;
            openAddProductRow(company);
          };
        }

        function toggleCompanyExpanded() {
          const body = card.querySelector(".company-card__body");
          const name = header.querySelector("span").textContent.trim();
          const willExpand = !body.classList.contains("expanded");

          body.classList.toggle("expanded", willExpand);
          if (toggleBtn) {
            toggleBtn.textContent = willExpand ? "Zwi cennik" : "Rozwi cennik";
          }

          if (willExpand) {
            expandedCompanies.add(name);
          } else {
            expandedCompanies.delete(name);
          }
        }

        if (toggleBtn) {
          toggleBtn.onclick = (e)=>{
            e.stopPropagation();
            toggleCompanyExpanded();
          };
        }

        header.onclick = (e)=>{
          if (e.target.closest(".remove-btn")) return;
          if (e.target.closest("button.company-card__toggle")) return;
          toggleCompanyExpanded();
        };
      });
    }

    function removePrice(company, product) {
      priceList = priceList.filter(p => !(p.company === company && p.product === product));
      renderAll();
    }
    function removeCompany(name) {
      companies = companies.filter(c => c !== name);
      priceList = priceList.filter(p => p.company !== name);
      expandedCompanies.delete(name);
      renderAll();
    }
    function removeProduct(name) {
      products = products.filter(p => p !== name);
      priceList = priceList.filter(pr => pr.product !== name);
      renderAll();
    }

    function openAddProductRow(company) {
      const cards = [...compareCompanies.querySelectorAll('.company-card')];
      const card = cards.find(c => c.querySelector('.company-card__header span').textContent.trim() === company);
      if (!card) return;

      const tbody = card.querySelector('table.products-table tbody');
      if (!tbody) return;

      let existing = tbody.querySelector('tr[data-new-row="true"]');
      if (existing) {
        const nameInputExisting = existing.querySelector('td:nth-child(1) input');
        existing.scrollIntoView({behavior:'smooth', block:'center'});
        nameInputExisting && nameInputExisting.focus();
        return;
      }

      const tr = document.createElement('tr');
      tr.setAttribute('data-new-row', 'true');

      const sortedProducts = [...products].sort((a, b) =>
        a.toLowerCase().localeCompare(b.toLowerCase())
      );

      tr.innerHTML = `
        <td>
          <input list="all-products-${company}" placeholder="Produkt (wybierz lub wpisz nowy)"/>
          <datalist id="all-products-${company}">
            ${sortedProducts.map(p => `<option value="${p}"></option>`).join('')}
          </datalist>
        </td>
        <td><input type="number" min="0.01" step="0.01" placeholder="Cena (z)"/></td>
        <td></td>
        <td>
          <button class="primary" data-save-inline="${company}">Zapisz</button>
          <button class="remove-btn" data-cancel-inline="1">Anuluj</button>
        </td>
      `;
      tbody.appendChild(tr);

      const nameInput = tr.querySelector('td:nth-child(1) input');
      nameInput && nameInput.focus();

      const saveBtn = tr.querySelector('button[data-save-inline]');
      saveBtn.onclick = ()=>{
        const productName = nameInput.value.trim();
        const priceInput = tr.querySelector('td:nth-child(2) input');
        const priceVal = priceInput.value.trim();

        if (!productName || !priceVal) {
          alert('Podaj nazw produktu i cen.');
          return;
        }
        const price = Number(priceVal);
        if (isNaN(price) || price <= 0) {
          alert('Podaj poprawn cen > 0.');
          return;
        }

        if (!products.includes(productName)) {
          products.push(productName);
        }

        priceList.push({company, product: productName, price: Number(price.toFixed(2))});
        renderAll();
      };

      const cancelBtn = tr.querySelector('button[data-cancel-inline]');
      cancelBtn.onclick = ()=>{
        tr.remove();
      };
    }

    // start dopiero po poprawnym logowaniu
    document.addEventListener("DOMContentLoaded", ()=>{
      loginPassword.focus();
    });
  </script>
</body>
</html>
