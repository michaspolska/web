<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Lista dostawców i cenniki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --color-background: #fcfcf9;
      --color-surface: #fffffd;
      --color-text: #13343b;
      --color-text-secondary: #626c71;
      --color-primary: #21808d;
      --color-primary-hover: #1d7480;
      --color-border: rgba(94, 82, 64, 0.2);
      --radius: 10px;
      --shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.07);
      --font: Inter, Geist, Arial, sans-serif;
      --space: 18px;
      --space-sm: 10px;
      --space-xs: 6px;
      --max-width: 1100px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--color-background);
      color: var(--color-text);
      font-family: var(--font);
      font-size: 16px;
      min-height: 100vh;
    }

    .container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--space);
    }

    h1 {
      margin-top: 0;
      font-size: 1.2rem;
      border-left: 4px solid var(--color-primary);
      padding-left: 10px;
    }

    h2 {
      font-size: 1rem;
      margin-top: var(--space);
      margin-bottom: var(--space-sm);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
    }

    .top-bar-buttons {
      display: flex;
      gap: 8px;
    }

    input, select, button {
      font-family: inherit;
      font-size: 0.95rem;
      padding: 7px 13px;
      border-radius: var(--radius);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      outline: none;
      transition: border-color .2s, background .2s;
    }

    input:focus,
    select:focus {
      border-color: var(--color-primary);
    }

    button.primary {
      background: var(--color-primary);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 500;
      padding-inline: 18px;
    }

    button.primary:hover {
      background: var(--color-primary-hover);
    }

    button.danger {
      background: #ff5555;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
    }

    button.danger:hover {
      background: #d1002a;
    }

    button.outline {
      background: var(--color-surface);
      color: var(--color-primary);
      border-color: var(--color-primary);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .info {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-sm);
    }

    .supplier-add {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: var(--space-sm);
      background: var(--color-surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: var(--space-sm);
    }

    .supplier-add input {
      flex: 1;
    }

    .supplier-card {
      background: var(--color-surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: var(--space);
      padding: var(--space-sm);
    }

    .supplier-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
    }

    .supplier-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .supplier-header-buttons {
      display: flex;
      gap: 6px;
    }

    .supplier-add-product {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .supplier-add-product input {
      min-width: 140px;
    }

    .supplier-add-product .prod-name {
      min-width: 260px;
    }

    .supplier-add-product .btn-add-product {
      flex: 0 0 auto;
    }

    .products-table-wrapper {
      overflow-x: auto;
    }

    .products-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--color-surface);
      table-layout: auto;
    }

    .products-table th,
    .products-table td {
      padding: 8px 10px;
      border: 1px solid var(--color-border);
      text-align: left;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .products-table th {
      background: #f5f7f8;
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    .products-table td.price-cell {
      text-align: right;
    }

    .products-table tr:nth-child(even) {
      background: #fafafa;
    }

    .products-table .tag-supplier {
      font-size: 0.8rem;
      color: var(--color-primary);
      margin-left: 4px;
    }

    #error {
      color: #d1002a;
      margin-top: 6px;
      font-size: 0.9rem;
    }

    /* zakładki */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tab-btn {
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      padding: 6px 14px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .tab-btn.active {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    @media (max-width: 700px) {
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .supplier-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <h1>Lista dostawców i cenniki</h1>
      <div class="top-bar-buttons">
        <button id="logoutBtn" class="outline">Wyloguj</button>
        <button id="reloadBtn" class="outline">Odśwież</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-suppliers">Dostawcy</button>
      <button class="tab-btn" data-tab="tab-products">Produkty</button>
    </div>

    <!-- Zakładka: Dostawcy -->
    <div id="tab-suppliers" class="tab-panel active">
      <div class="supplier-add">
        <input type="text" id="newSupplierName" placeholder="Wpisz nazwę dostawcy...">
        <button id="addSupplierBtn" class="primary">Dodaj dostawcę</button>
      </div>

      <p class="info">
        W cenniku dostawcy możesz skorygować VAT dla produktu, zmiana zaktualizuje stawkę tego produktu wszędzie.
      </p>

      <div id="suppliersContainer"></div>
      <div id="error"></div>
    </div>

    <!-- Zakładka: Produkty -->
    <div id="tab-products" class="tab-panel">
      <h2>Lista produktów i najtańsze ceny</h2>
      <p class="info">
        Poniżej widać najniższą cenę netto i dostawcę dla każdego produktu.
      </p>
      <div class="products-table-wrapper">
        <table id="productsSummaryTable" class="products-table">
          <thead>
            <tr>
              <th>Produkt</th>
              <th>Jednostka</th>
              <th>Najtańsza cena netto</th>
              <th>Dostawca</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_SUPPLIERS_URL        = "https://a1.justmike.space/app/list_suppliers.pl";
    const API_ADD_SUPPLIER         = "https://a1.justmike.space/app/add_supplier.pl";
    const API_DELETE_SUPPLIER      = "https://a1.justmike.space/app/delete_supplier.pl";
    const API_ADD_PRODUCT          = "https://a1.justmike.space/app/add_supplier_product.pl";
    const API_DELETE_SUPPLIER_PROD = "https://a1.justmike.space/app/delete_supplier_product.pl";
    const API_PRODUCTS_URL         = "https://a1.justmike.space/app/list_products.pl";
    const API_LOGOUT_URL           = "https://a1.justmike.space/app/logout.pl";
    const LOGIN_PAGE               = "/login.html";

    // products: {id, name, price_net, vat, unit}
    let MASTER_PRODUCTS = [];

    function getCsrfToken() {
      return sessionStorage.getItem("csrfToken") || "";
    }

    function formatPLN(value) {
      if (value === null || value === undefined || value === "") return "";
      const num = Number(value);
      if (Number.isNaN(num)) return value;
      return num.toLocaleString("pl-PL", { style: "currency", currency: "PLN" });
    }

    async function loadMasterProducts() {
      const csrf = getCsrfToken();
      try {
        const resp = await fetch(API_PRODUCTS_URL, {
          method: "GET",
          credentials: "include",
          headers: {
            "Accept": "application/json",
            "X-CSRF-Token": csrf
          }
        });
        if (!resp.ok) {
          console.error("Błąd list_products.pl:", resp.status);
          MASTER_PRODUCTS = [];
          return;
        }
        const data = await resp.json();
        MASTER_PRODUCTS = Array.isArray(data) ? data : [];
      } catch (e) {
        console.error("Błąd połączenia list_products.pl:", e);
        MASTER_PRODUCTS = [];
      }
    }

    // przebuduj wszystkie datalisty wg MASTER_PRODUCTS (nazwa + VAT + cena)
    function refreshAllDatalists() {
      document.querySelectorAll(".supplier-card").forEach(card => {
        const supplierId = card.dataset.supplierId;
        const datalistId = `products-master-list-${supplierId}`;
        const dl = document.getElementById(datalistId);
        if (!dl) return;

        let optionsHtml = "";
        for (const prod of MASTER_PRODUCTS) {
          const vatTxt = prod.vat != null && prod.vat !== "" ? prod.vat + " %" : "";
          const priceTxt = prod.price_net != null && prod.price_net !== ""
            ? formatPLN(prod.price_net)
            : "";
          let label = prod.name;
          if (vatTxt)   label += " – " + vatTxt;
          if (priceTxt) label += " – " + priceTxt;

          optionsHtml += `<option value="${prod.name}"
                                 data-price="${prod.price_net ?? ""}"
                                 data-vat="${prod.vat ?? ""}"
                                 data-unit="${prod.unit ?? ""}">${label}</option>`;
        }

        dl.innerHTML = optionsHtml;
      });
    }

    // globalna funkcja licząca najtańszą cenę netto
    function recomputeLowestNetPrices() {
      // mapa: nazwa produktu -> { price: number, supplierName: string, unit: string }
      const minByProduct = new Map();

      // 1) zbierz minimalną cenę dla każdego produktu
      document.querySelectorAll(".supplier-card").forEach(card => {
        const supplierName = card.querySelector(".supplier-name")?.textContent || "";
        const rows = card.querySelectorAll("tbody tr");

        rows.forEach(tr => {
          const tds = tr.querySelectorAll("td");
          if (tds.length < 3) return;

          const name  = tds[0].textContent.trim();
          const unit  = tds[1].textContent.trim();
          const netTd = tds[2];

          if (!name) return;

          const netText = netTd.textContent.trim()
            .replace(/\s/g, "")
            .replace("zł", "")
            .replace(",", ".");
          const price = parseFloat(netText);
          if (isNaN(price)) return;

          const current = minByProduct.get(name);
          if (!current || price < current.price) {
            minByProduct.set(name, { price, supplierName, unit });
          }
        });
      });

      // 2) wstaw najtańszą cenę + nazwę firmy do kolumny "Najtańsza cena netto" w kartach
      document.querySelectorAll(".supplier-card").forEach(card => {
        const rows = card.querySelectorAll("tbody tr");
        rows.forEach(tr => {
          const tds = tr.querySelectorAll("td");
          if (tds.length < 6) return;

          const name = tds[0].textContent.trim();
          const lowestCell = tds[5]; // kolumna "Najtańsza cena netto"
          const entry = minByProduct.get(name);
          if (!entry) {
            lowestCell.textContent = "";
            return;
          }

          lowestCell.innerHTML = `
            ${formatPLN(entry.price)}
            <span class="tag-supplier">(${entry.supplierName})</span>
          `;
        });
      });

      // 3) zbuduj tabelę zbiorczą w zakładce "Produkty"
      const summaryBody = document.querySelector("#productsSummaryTable tbody");
      if (!summaryBody) return;

      const entries = Array.from(minByProduct.entries())
        .sort((a, b) => a[0].localeCompare(b[0], "pl"));

      summaryBody.innerHTML = "";
      entries.forEach(([name, info]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td>${info.unit || ""}</td>
          <td class="price-cell">${formatPLN(info.price)}</td>
          <td>${info.supplierName}</td>
        `;
        summaryBody.appendChild(tr);
      });
    }

    function createSupplierCard(supplier) {
      const card = document.createElement("div");
      card.className = "supplier-card";
      card.dataset.supplierId = supplier.id;

      const header = document.createElement("div");
      header.className = "supplier-header";

      const nameEl = document.createElement("div");
      nameEl.className = "supplier-name";
      nameEl.textContent = supplier.name;

      const headerBtns = document.createElement("div");
      headerBtns.className = "supplier-header-buttons";

      const toggleBtn = document.createElement("button");
      toggleBtn.className = "outline";
      toggleBtn.textContent = "Zwiń cennik";
      toggleBtn.addEventListener("click", () => {
        const tableWrap = card.querySelector(".products-table-wrapper");
        const hidden = tableWrap.style.display === "none";
        tableWrap.style.display = hidden ? "block" : "none";
        toggleBtn.textContent = hidden ? "Zwiń cennik" : "Rozwiń cennik";
      });

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "danger";
      deleteBtn.textContent = "Usuń dostawcę";
      deleteBtn.addEventListener("click", () => deleteSupplier(supplier.id));

      headerBtns.appendChild(toggleBtn);
      headerBtns.appendChild(deleteBtn);

      header.appendChild(nameEl);
      header.appendChild(headerBtns);

      // formularz dodawania produktu
      const addRow = document.createElement("div");
      addRow.className = "supplier-add-product";

      const datalistId = `products-master-list-${supplier.id}`;

      let optionsHtml = "";
      for (const prod of MASTER_PRODUCTS) {
        const vatTxt = prod.vat != null && prod.vat !== "" ? prod.vat + " %" : "";
        const priceTxt = prod.price_net != null && prod.price_net !== ""
          ? formatPLN(prod.price_net)
          : "";
        let label = prod.name;
        if (vatTxt)   label += " – " + vatTxt;
        if (priceTxt) label += " – " + priceTxt;

        optionsHtml += `<option value="${prod.name}"
                               data-price="${prod.price_net ?? ""}"
                               data-vat="${prod.vat ?? ""}"
                               data-unit="${prod.unit ?? ""}">${label}</option>`;
      }

      addRow.innerHTML = `
        <input list="${datalistId}" class="prod-name" placeholder="Nazwa produktu (możesz wpisać nowy)">
        <datalist id="${datalistId}">
          ${optionsHtml}
        </datalist>
        <select class="prod-unit">
          <option value="szt">szt</option>
          <option value="kg">kg</option>
          <option value="l">l</option>
        </select>
        <input type="number" step="0.01" min="0" class="prod-price-net" placeholder="Cena netto">
        <input type="number" step="1" min="0" class="prod-vat" placeholder="VAT %" value="23">
        <button type="button" class="primary btn-add-product">+ Dodaj produkt</button>
      `;

      const nameInput  = addRow.querySelector(".prod-name");
      const netInput   = addRow.querySelector(".prod-price-net");
      const vatInput   = addRow.querySelector(".prod-vat");
      const unitSelect = addRow.querySelector(".prod-unit");

      // po wyborze nazwy z listy ustaw cenę, VAT i jednostkę z mastera
      nameInput.addEventListener("input", () => {
        const dl = document.getElementById(datalistId);
        if (!dl) return;
        const val = nameInput.value;
        const opts = dl.options;
        for (let i = 0; i < opts.length; i++) {
          if (opts[i].value === val) {
            const p    = opts[i].getAttribute("data-price");
            const vat  = opts[i].getAttribute("data-vat");
            const unit = opts[i].getAttribute("data-unit");
            if (p !== null && p !== "") {
              netInput.value = p;
            }
            if (vat !== null && vat !== "") {
              vatInput.value = vat;
            }
            if (unit !== null && unit !== "") {
              unitSelect.value = unit;
            }
            break;
          }
        }
      });

      const addBtn = addRow.querySelector(".btn-add-product");
      addBtn.addEventListener("click", () => addProductForSupplier(card, supplier.id));

      const tableWrap = document.createElement("div");
      tableWrap.className = "products-table-wrapper";

      const table = document.createElement("table");
      table.className = "products-table";

      table.innerHTML = `
        <thead>
          <tr>
            <th>Produkt</th>
            <th>Jednostka</th>
            <th>Cena netto</th>
            <th>VAT %</th>
            <th>Cena brutto</th>
            <th>Najtańsza cena netto</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");

      if (Array.isArray(supplier.products) && supplier.products.length > 0) {
        for (const p of supplier.products) {
          const tr = document.createElement("tr");
          tr.dataset.supplierProductId = p.id;
          tr.innerHTML = `
            <td>${p.name}</td>
            <td>${p.unit || ""}</td>
            <td class="price-cell price-cell-net">${formatPLN(p.price_net)}</td>
            <td>${p.vat != null ? p.vat + " %" : ""}</td>
            <td class="price-cell">${formatPLN(p.price_gross)}</td>
            <td class="price-cell">
              ${p.lowest_net != null ? formatPLN(p.lowest_net) : ""}
              ${p.lowest_supplier ? `<span class="tag-supplier">(${p.lowest_supplier})</span>` : ""}
            </td>
            <td>
              <button type="button" class="danger btn-del-product">Usuń</button>
            </td>
          `;
          const delBtn = tr.querySelector(".btn-del-product");
          delBtn.addEventListener("click", () => deleteProductRow(tr));
          tbody.appendChild(tr);
        }
      } else {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="7">Brak produktów w cenniku.</td>`;
        tbody.appendChild(tr);
      }

      tableWrap.appendChild(table);
      card.appendChild(header);
      card.appendChild(addRow);
      card.appendChild(tableWrap);

      return card;
    }

    async function loadSuppliers() {
      const errorBox  = document.getElementById("error");
      const container = document.getElementById("suppliersContainer");
      errorBox.textContent = "";
      container.innerHTML = "<p class='info'>Ładowanie cenników...</p>";

      await loadMasterProducts();

      const csrf = getCsrfToken();

      try {
        const resp = await fetch(API_SUPPLIERS_URL, {
          method: "GET",
          credentials: "include",
          headers: {
            "Accept": "application/json",
            "X-CSRF-Token": csrf
          }
        });

        if (resp.status === 401) {
          container.innerHTML = "";
          errorBox.textContent = "Brak autoryzacji – zaloguj się ponownie.";
          return;
        }

        if (resp.status === 403) {
          container.innerHTML = "";
          errorBox.textContent = "Błąd bezpieczeństwa (CSRF) – zaloguj się ponownie.";
          return;
        }

        if (!resp.ok) {
          container.innerHTML = "";
          errorBox.textContent = "Błąd serwera: " + resp.status;
          return;
        }

        const data = await resp.json();
        container.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = "<p class='info'>Brak dostawców.</p>";
          return;
        }

        for (const s of data) {
          const card = createSupplierCard(s);
          container.appendChild(card);
        }

        // po zbudowaniu kart przelicz najtańsze ceny
        recomputeLowestNetPrices();

      } catch (e) {
        container.innerHTML = "";
        errorBox.textContent = "Błąd połączenia: " + e.message;
      }
    }

    async function addSupplier() {
      const nameInput = document.getElementById("newSupplierName");
      const name      = nameInput.value.trim();
      const errorBox  = document.getElementById("error");

      if (!name) {
        errorBox.textContent = "Podaj nazwę dostawcy.";
        return;
      }

      const csrf = getCsrfToken();

      try {
        const resp = await fetch(API_ADD_SUPPLIER, {
          method: "POST",
          credentials: "include",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "X-CSRF-Token": csrf
          },
          body: JSON.stringify({ name })
        });

        if (!resp.ok) {
          const t = await resp.text();
          errorBox.textContent = "Błąd dodawania dostawcy: " + t;
          return;
        }

        const data = await resp.json();
        if (!data.ok) {
          errorBox.textContent = "Błąd dodawania dostawcy: " + (data.error || "unknown");
          return;
        }

        nameInput.value = "";
        errorBox.textContent = "";
        await loadSuppliers();
      } catch (e) {
        errorBox.textContent = "Błąd połączenia: " + e.message;
      }
    }

    async function addProductForSupplier(cardEl, supplierId) {
      const errorBox  = document.getElementById("error");
      const nameInput = cardEl.querySelector(".prod-name");
      const unitSel   = cardEl.querySelector(".prod-unit");
      const netInput  = cardEl.querySelector(".prod-price-net");
      const vatInput  = cardEl.querySelector(".prod-vat");

      const new_name  = (nameInput.value || "").trim();
      const unit      = unitSel.value;
      const price_net = (netInput.value || "").trim();
      const vat       = (vatInput.value || "").trim();

      if (!new_name) {
        errorBox.textContent = "Podaj nazwę produktu.";
        return;
      }
      if (!price_net) {
        errorBox.textContent = "Podaj cenę netto.";
        return;
      }

      const csrf = getCsrfToken();

      try {
        const resp = await fetch(API_ADD_PRODUCT, {
          method: "POST",
          credentials: "include",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "X-CSRF-Token": csrf
          },
          body: JSON.stringify({
            supplier_id: supplierId,
            product_id: null,
            new_name,
            unit,
            price_net,
            vat
          })
        });

        if (!resp.ok) {
          const t = await resp.text();
          errorBox.textContent = "Błąd dodawania produktu: " + t;
          return;
        }

        const data = await resp.json();
        if (!data.ok) {
          errorBox.textContent = "Błąd dodawania produktu: " + (data.error || "unknown");
          return;
        }

        if (data.master_product) {
          MASTER_PRODUCTS.push(data.master_product);
          refreshAllDatalists();
        }

        nameInput.value  = "";
        netInput.value   = "";
        vatInput.value   = "23";
        unitSel.value    = "szt";

        const tbody = cardEl.querySelector(".products-table tbody");
        const p = data.product;
        const tr = document.createElement("tr");
        tr.dataset.supplierProductId = p.id;
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.unit || ""}</td>
          <td class="price-cell price-cell-net">${formatPLN(p.price_net)}</td>
          <td>${p.vat != null ? p.vat + " %" : ""}</td>
          <td class="price-cell">${formatPLN(p.price_gross)}</td>
          <td class="price-cell"></td>
          <td><button type="button" class="danger btn-del-product">Usuń</button></td>
        `;
        const delBtn = tr.querySelector(".btn-del-product");
        delBtn.addEventListener("click", () => deleteProductRow(tr));

        if (tbody.children.length === 1 &&
            tbody.children[0].querySelector("td[colspan]")) {
          tbody.innerHTML = "";
        }
        tbody.appendChild(tr);

        // po dodaniu produktu przelicz najtańsze
        recomputeLowestNetPrices();

        errorBox.textContent = "";
      } catch (e) {
        errorBox.textContent = "Błąd połączenia: " + e.message;
      }
    }

    async function deleteProductRow(tr) {
      const errorBox = document.getElementById("error");
      const supplierProductId = tr.dataset.supplierProductId;

      if (!supplierProductId) {
        errorBox.textContent = "Brak ID produktu do usunięcia.";
        return;
      }
      if (!confirm("Na pewno usunąć ten produkt z cennika?")) return;

      const csrf = getCsrfToken();

      try {
        const resp = await fetch(API_DELETE_SUPPLIER_PROD, {
          method: "POST",
          credentials: "include",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "X-CSRF-Token": csrf
          },
          body: JSON.stringify({ supplier_product_id: supplierProductId })
        });

        if (!resp.ok) {
          const t = await resp.text();
          errorBox.textContent = "Błąd usuwania produktu: " + t;
          return;
        }

        const data = await resp.json();
        if (!data.ok) {
          errorBox.textContent = "Błąd usuwania produktu: " + (data.error || "unknown");
          return;
        }

        const tbody = tr.parentElement;
        tr.remove();

        if (tbody.children.length === 0) {
          const emptyTr = document.createElement("tr");
          emptyTr.innerHTML = `<td colspan="7">Brak produktów w cenniku.</td>`;
          tbody.appendChild(emptyTr);
        }

        // po usunięciu przelicz najtańsze
        recomputeLowestNetPrices();

        errorBox.textContent = "";
      } catch (e) {
        errorBox.textContent = "Błąd połączenia: " + e.message;
      }
    }

    async function deleteSupplier(id) {
      const errorBox = document.getElementById("error");
      const csrf = getCsrfToken();

      if (!confirm("Na pewno usunąć tego dostawcę wraz z cennikiem?")) return;

      try {
        const resp = await fetch(API_DELETE_SUPPLIER, {
          method: "POST",
          credentials: "include",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "X-CSRF-Token": csrf
          },
          body: JSON.stringify({ supplier_id: id })
        });

        if (!resp.ok) {
          const t = await resp.text();
          errorBox.textContent = "Błąd usuwania dostawcy: " + t;
          return;
        }

        const data = await resp.json();
        if (!data.ok) {
          errorBox.textContent = "Błąd usuwania dostawcy: " + (data.error || "unknown");
          return;
        }

        errorBox.textContent = "";
        await loadSuppliers();
      } catch (e) {
        errorBox.textContent = "Błąd połączenia: " + e.message;
      }
    }

    async function doLogout() {
      const csrf = getCsrfToken();
      try {
        await fetch(API_LOGOUT_URL, {
          method: "POST",
          credentials: "include",
          headers: {
            "Accept": "application/json",
            "X-CSRF-Token": csrf
          }
        });
      } catch (_) {}
      sessionStorage.removeItem("csrfToken");
      window.location.href = LOGIN_PAGE;
    }

    // przełączanie zakładek
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".tab-btn");
      if (!btn) return;
      const tabId = btn.dataset.tab;
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll(".tab-panel").forEach(p => {
        p.classList.toggle("active", p.id === tabId);
      });
    });

    document.getElementById("reloadBtn").addEventListener("click", async () => {
      await loadMasterProducts();
      await loadSuppliers();
    });
    document.getElementById("addSupplierBtn").addEventListener("click", addSupplier);
    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    window.addEventListener("load", async () => {
      await loadMasterProducts();
      await loadSuppliers();
    });
  </script>
</body>
</html>
