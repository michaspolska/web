<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Lista dostawc√≥w i ich cenniki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ... ten sam CSS jak wcze≈õniej ... */
    :root {
      --color-background: #fcfcf9;
      --color-surface: #fffffd;
      --color-text: #13343b;
      --color-text-secondary: #626c71;
      --color-primary: #21808d;
      --color-primary-hover: #1d7480;
      --color-border: rgba(94, 82, 64, 0.2);
      --radius: 10px;
      --shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.07);
      --font: Inter, Geist, Arial, sans-serif;
      --space: 18px;
      --space-sm: 10px;
      --space-xs: 6px;
      --max-width: 1100px;
    }

    /* ... reszta CSS bez zmian ... */
  </style>
</head>
<body>
  <!-- ... ten sam HTML jak wcze≈õniej ... -->
  <div class="container">
    <div class="top-bar">
      <h1>Lista dostawc√≥w i ich cenniki</h1>
      <div class="top-bar-buttons">
        <button id="logoutBtn" class="outline">Wyloguj</button>
        <button id="reloadBtn" class="outline">Od≈õwie≈º</button>
        <button id="testConnBtn" class="outline">Test po≈ÇƒÖczenia</button>
      </div>
    </div>
    <!-- ... reszta HTML bez zmian ... -->
  </div>

  <script>
    const API_SUPPLIERS_URL        = "https://a1.justmike.space/app/list_suppliers.pl";
    const API_ADD_SUPPLIER         = "https://a1.justmike.space/app/add_supplier.pl";
    const API_DELETE_SUPPLIER      = "https://a1.justmike.space/app/delete_supplier.pl";
    const API_ADD_PRODUCT          = "https://a1.justmike.space/app/add_supplier_product.pl";
    const API_DELETE_SUPPLIER_PROD = "https://a1.justmike.space/app/delete_supplier_product.pl";
    const API_PRODUCTS_URL         = "https://a1.justmike.space/app/list_products.pl";
    const API_LOGOUT_URL           = "https://a1.justmike.space/app/logout.pl";
    const LOGIN_PAGE               = "/login.html";

    let MASTER_PRODUCTS = [];

    function getCsrfToken() {
      return sessionStorage.getItem("csrfToken") || "";
    }

    function formatPLN(value) {
      if (value === null || value === undefined || value === "") return "";
      const num = Number(value);
      if (Number.isNaN(num)) return value;
      return num.toLocaleString("pl-PL", { style: "currency", currency: "PLN" });
    }

    // üîß Ulepszona funkcja fetch z pe≈Çnym debugowaniem
    async function apiFetch(url, options = {}) {
      const csrf = getCsrfToken();
      const defaultOptions = {
        credentials: "include",
        headers: {
          "Accept": "application/json",
          "X-CSRF-Token": csrf,
          ...options.headers
        }
      };

      const config = { ...defaultOptions, ...options };

      console.log(`üåê API Request: ${url}`, {
        method: config.method || 'GET',
        csrf: csrf ? 'present' : 'missing',
        credentials: config.credentials
      });

      try {
        const response = await fetch(url, config);
        
        console.log(`üì° API Response: ${url} ‚Üí ${response.status} ${response.statusText}`);
        console.log('Headers:', [...response.headers.entries()]);

        // Sprawd≈∫ CORS preflight
        if (response.status === 0) {
          throw new Error('CORS blocked (status 0)');
        }

        if (!response.ok) {
          let errorText = '';
          try {
            errorText = await response.text();
          } catch {
            errorText = 'No response body';
          }
          console.error('‚ùå API Error details:', { status: response.status, errorText });
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('‚úÖ API Success:', data);
        return data;

      } catch (error) {
        console.error(`üí• Fetch error dla ${url}:`, error);
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          throw new Error(`Brak po≈ÇƒÖczenia sieciowego lub CORS: ${error.message}`);
        }
        if (error.message.includes('CORS')) {
          throw new Error('B≈ÇƒÖd CORS - sprawd≈∫ czy serwer zezwala na ≈ºƒÖdania z tej domeny');
        }
        if (error.message.includes('Failed to fetch')) {
          throw new Error('Failed to fetch - sprawd≈∫: 1) po≈ÇƒÖczenie internetowe, 2) czy serwer dzia≈Ça, 3) CORS');
        }
        
        throw error;
      }
    }

    // üîß Test po≈ÇƒÖczenia
    async function testConnection() {
      const errorBox = document.getElementById("error");
      try {
        errorBox.innerHTML = '<span style="color: orange;">Testowanie po≈ÇƒÖczenia...</span>';
        
        // Test 1: prosty GET bez CSRF
        const testResp = await fetch("https://a1.justmike.space/", { 
          method: 'GET',
          credentials: 'include'
        });
        
        console.log('üè† Main page test:', testResp.status);
        
        // Test 2: products z pe≈Çnym apiFetch
        await apiFetch(API_PRODUCTS_URL, { method: 'GET' });
        
        errorBox.innerHTML = '<span style="color: green;">‚úÖ Po≈ÇƒÖczenie dzia≈Ça poprawnie!</span>';
        setTimeout(() => errorBox.textContent = '', 3000);
        
      } catch (e) {
        console.error('üî¥ Connection test failed:', e);
        errorBox.innerHTML = `<span style="color: red;">‚ùå B≈ÇƒÖd: ${e.message}</span>`;
      }
    }

    async function loadMasterProducts() {
      try {
        const data = await apiFetch(API_PRODUCTS_URL);
        MASTER_PRODUCTS = Array.isArray(data) ? data : [];
        console.log(`üì¶ Za≈Çadowano ${MASTER_PRODUCTS.length} produkt√≥w`);
        return true;
      } catch (e) {
        console.error('‚ùå B≈ÇƒÖd ≈Çadowania produkt√≥w:', e);
        MASTER_PRODUCTS = [];
        throw e;
      }
    }

    function createDatalistHtml(supplierId) {
      const datalistId = `products-master-list-${supplierId}`;
      let optionsHtml = "";
      
      for (const prod of MASTER_PRODUCTS) {
        const vatTxt = prod.vat != null && prod.vat !== "" ? prod.vat + " %" : "";
        const priceTxt = prod.price_net != null && prod.price_net !== ""
          ? formatPLN(prod.price_net)
          : "";
        let label = prod.name;
        if (vatTxt) label += " ‚Äì " + vatTxt;
        if (priceTxt) label += " ‚Äì " + priceTxt;

        optionsHtml += `<option value="${prod.name}"
                               data-price="${prod.price_net ?? ""}"
                               data-vat="${prod.vat ?? ""}"
                               data-unit="${prod.unit ?? ""}">${label}</option>`;
      }

      return `
        <input list="${datalistId}" class="prod-name" placeholder="Nazwa produktu (mo≈ºesz wpisaƒá nowy)">
        <datalist id="${datalistId}">
          ${optionsHtml}
        </datalist>
        <select class="prod-unit">
          <option value="szt">szt</option>
          <option value="kg">kg</option>
          <option value="l">l</option>
        </select>
        <input type="number" step="0.01" min="0" class="prod-price-net" placeholder="Cena netto">
        <input type="number" step="1" min="0" class="prod-vat" placeholder="VAT %" value="23">
        <button type="button" class="primary btn-add-product">+ Dodaj produkt</button>
      `;
    }

    function refreshAllDatalists() {
      document.querySelectorAll(".supplier-card").forEach(card => {
        const supplierId = card.dataset.supplierId;
        const addRow = card.querySelector(".supplier-add-product");
        if (!addRow) return;

        addRow.innerHTML = createDatalistHtml(supplierId);
        
        const nameInput = addRow.querySelector(".prod-name");
        setupProductNameListener(nameInput, supplierId);
        const addBtn = addRow.querySelector(".btn-add-product");
        addBtn.addEventListener("click", () => addProductForSupplier(card, supplierId));
      });
    }

    function setupProductNameListener(nameInput, supplierId) {
      nameInput.addEventListener("input", () => {
        const datalistId = `products-master-list-${supplierId}`;
        const dl = document.getElementById(datalistId);
        if (!dl) return;
        
        const val = nameInput.value;
        const opts = dl.options;
        for (let i = 0; i < opts.length; i++) {
          if (opts[i].value === val) {
            const container = nameInput.closest(".supplier-add-product");
            const netInput = container.querySelector(".prod-price-net");
            const vatInput = container.querySelector(".prod-vat");
            const unitSelect = container.querySelector(".prod-unit");
            
            const p = opts[i].getAttribute("data-price");
            const vat = opts[i].getAttribute("data-vat");
            const unit = opts[i].getAttribute("data-unit");
            
            if (p !== null && p !== "") netInput.value = p;
            if (vat !== null && vat !== "") vatInput.value = vat;
            if (unit !== null && unit !== "") unitSelect.value = unit;
            break;
          }
        }
      });
    }

    // ... reszta funkcji createSupplierCard bez zmian (skr√≥cona dla czytelno≈õci) ...

    async function loadSuppliers() {
      const errorBox = document.getElementById("error");
      const container = document.getElementById("suppliersContainer");
      
      errorBox.textContent = "";
      container.innerHTML = "<p class='info'>≈Åadowanie cennik√≥w...</p>";

      try {
        // 1. Najpierw produkty
        await loadMasterProducts();
        
        // 2. Potem dostawcy
        const suppliers = await apiFetch(API_SUPPLIERS_URL);
        container.innerHTML = "";

        if (!Array.isArray(suppliers) || suppliers.length === 0) {
          container.innerHTML = "<p class='info'>Brak dostawc√≥w.</p>";
          return;
        }

        for (const s of suppliers) {
          const card = createSupplierCard(s);
          container.appendChild(card);
        }
      } catch (e) {
        console.error('üí• loadSuppliers error:', e);
        container.innerHTML = "";
        errorBox.textContent = e.message;
      }
    }

    // ... reszta funkcji (addSupplier, addProductForSupplier, etc.) bez zmian tylko z apiFetch zamiast fetch ...

    // Event listenery z debugowaniem
    document.getElementById("testConnBtn")?.addEventListener("click", testConnection);
    document.getElementById("reloadBtn").addEventListener("click", loadSuppliers);

    window.addEventListener("load", async () => {
      console.log('üöÄ Aplikacja startuje...');
      console.log('CSRF:', getCsrfToken() ? 'OK' : 'BRAK');
      await loadSuppliers();
    });

    // üîç Debug konsoli
    window.addEventListener('online', () => console.log('üåê Online'));
    window.addEventListener('offline', () => console.log('üîå Offline'));
  </script>
</body>
</html>
