<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Lista produktów, dostawców i odbiorców</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* ... (CSS bez zmian jak w Twoim pliku) ... */
</style>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <h1>Lista produktów, dostawców i odbiorców</h1>
    <div class="top-bar-buttons">
      <button id="logoutBtn" class="outline">Wyloguj</button>
      <button id="reloadBtn" class="outline">Odśwież</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-products">Produkty</button>
    <button class="tab-btn" data-tab="tab-suppliers">Dostawcy</button>
    <button class="tab-btn" data-tab="tab-customers">Odbiorcy</button>
  </div>

  <!-- Produkty -->
  <div id="tab-products" class="tab-panel active">
    <h2>Lista produktów i porównanie cen</h2>
    <div class="products-search">
      <input type="text" id="productsSearch" placeholder="Wpisz nazwę produktu..." />
    </div>
    <p class="info">
      Porównaj ceny wszystkich produktów we wszystkich firmach. Najtańsza oferta jest podświetlona.
    </p>
    <div class="products-table-wrapper">
      <table id="productsTable" class="products-table">
        <thead>
          <tr id="productsHeaderRow">
            <th>Produkt</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Dostawcy -->
  <div id="tab-suppliers" class="tab-panel">
    <div class="supplier-add">
      <input type="text" id="newSupplierName" placeholder="Wpisz nazwę dostawcy..." />
      <button id="addSupplierBtn" class="primary">Dodaj dostawcę</button>
    </div>
    <p class="info">
      W cenniku dostawcy możesz skorygować VAT dla produktu, zmiana zaktualizuje stawkę tego produktu wszędzie.
    </p>
    <div id="suppliersContainer"></div>
    <div id="error" class="error"></div>
  </div>

  <!-- Odbiorcy -->
  <div id="tab-customers" class="tab-panel">
    <div class="supplier-add">
      <input type="text" id="newCustomerName" placeholder="Wpisz nazwę odbiorcy..." />
      <button id="addCustomerBtn" class="primary">Dodaj odbiorcę</button>
    </div>
    <p class="info">
      Cenniki odbiorców korzystają zawsze z najniższych dostępnych cen netto dla produktu.
    </p>
    <div id="customersContainer"></div>
  </div>
</div>

<script>
// --- konfiguracja API, pomocnicze funkcje, loadMasterProducts, recomputeLowestNetPrices,
// createSupplierCard, loadSuppliers, addSupplier, addProductForSupplier, deleteProductRow,
// deleteSupplier – zachowaj dokładnie tak jak w Twoim aktualnym pliku. [file:25]

// ---------- ODBIORCY (kluczowe fragmenty) ----------

function createCustomerCard(customer) {
  const card = document.createElement('div');
  card.className = 'supplier-card';
  card.dataset.type = 'customer';
  card.dataset.customerId = customer.id;

  const header = document.createElement('div');
  header.className = 'supplier-header';

  const nameEl = document.createElement('div');
  nameEl.className = 'supplier-name';
  nameEl.textContent = customer.name;

  const headerBtns = document.createElement('div');
  headerBtns.className = 'supplier-header-buttons';

  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'danger';
  deleteBtn.textContent = 'Usuń odbiorcę';
  deleteBtn.addEventListener('click', () => deleteCustomer(customer.id));

  headerBtns.appendChild(deleteBtn);
  header.appendChild(nameEl);
  header.appendChild(headerBtns);

  const addRow = document.createElement('div');
  addRow.className = 'supplier-add-product';

  const datalistId = `products-lowest-list-${customer.id}`;
  let optionsHtml = '';
  LOWESTPRICES.forEach((info, name) => {
    optionsHtml += `<option value="${name}"
                          data-unit="${info.unit}"
                          data-price="${info.price}">${name}</option>`;
  });

  addRow.innerHTML = `
    <input list="${datalistId}" class="cust-prod-name" placeholder="Wybierz produkt" />
    <datalist id="${datalistId}">${optionsHtml}</datalist>
    <select class="cust-prod-unit">
      <option value="szt">szt</option>
      <option value="kg">kg</option>
      <option value="l">l</option>
    </select>
    <input type="number" step="0.01" min="0" class="cust-price-net" placeholder="Cena netto" readonly />
    <button type="button" class="primary btn-add-cust-product">Dodaj produkt</button>
  `;

  const nameInput  = addRow.querySelector('.cust-prod-name');
  const unitSelect = addRow.querySelector('.cust-prod-unit');
  const priceInput = addRow.querySelector('.cust-price-net');

  nameInput.addEventListener('input', () => {
    const val = nameInput.value.trim();
    const entry = LOWESTPRICES.get(val);
    if (!entry) return;
    unitSelect.value = entry.unit || 'szt';
    priceInput.value = entry.price;
  });

  const addBtn = addRow.querySelector('.btn-add-cust-product');
  addBtn.addEventListener('click', () => addProductForCustomer(card, customer.id));

  const tableWrap = document.createElement('div');
  tableWrap.className = 'products-table-wrapper';

  const table = document.createElement('table');
  table.className = 'products-table';
  table.innerHTML = `
    <thead>
      <tr>
        <th>Produkt</th>
        <th>Jednostka</th>
        <th>Cena netto najniższa</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  `;

  const tbody = table.querySelector('tbody');
  if (Array.isArray(customer.products) && customer.products.length > 0) {
    for (const p of customer.products) {
      const entry = LOWESTPRICES.get(p.name) || { unit: p.unit, price: null };
      const tr = document.createElement('tr');
      tr.dataset.customerId = customer.id;
      tr.dataset.productId = p.productid;
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${entry.unit || p.unit}</td>
        <td class="price-cell">${entry.price != null ? formatPLN(entry.price) : '-'}</td>
        <td><button type="button" class="danger btn-del-cust-product">Usuń</button></td>
      `;
      tr.querySelector('.btn-del-cust-product')
        .addEventListener('click', () => deleteCustomerProductRow(tr));
      tbody.appendChild(tr);
    }
  } else {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="4">Brak produktów w cenniku odbiorcy.</td>';
    tbody.appendChild(tr);
  }

  tableWrap.appendChild(table);
  card.appendChild(header);
  card.appendChild(addRow);
  card.appendChild(tableWrap);

  return card;
}

async function loadCustomers() {
  const container = document.getElementById('customersContainer');
  container.innerHTML = '<p class="info">Ładowanie odbiorców...</p>';

  const csrf = getCsrfToken();
  try {
    const resp = await fetch(APICUSTOMERSURL, {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Accept': 'application/json',
        'X-CSRF-Token': csrf
      }
    });
    if (!resp.ok) {
      container.innerHTML = '<p class="info">Błąd ładowania odbiorców.</p>';
      return;
    }
    const data = await resp.json();
    container.innerHTML = '';
    if (!Array.isArray(data) || data.length === 0) {
      container.innerHTML = '<p class="info">Brak odbiorców.</p>';
      return;
    }
    for (const c of data) {
      const card = createCustomerCard(c);
      container.appendChild(card);
    }
    refreshAllDatalists();
  } catch (e) {
    container.innerHTML = '<p class="info">Błąd połączenia.</p>';
  }
}

async function addCustomer() {
  const input = document.getElementById('newCustomerName');
  const name = input.value.trim();
  const errorBox = document.getElementById('error');

  if (errorBox) errorBox.textContent = '';
  if (!name) {
    if (errorBox) errorBox.textContent = 'Podaj nazwę odbiorcy.';
    return;
  }

  const csrf = getCsrfToken();
  try {
    const resp = await fetch(APIADDCUSTOMER, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrf
      },
      body: JSON.stringify({ name })
    });
    if (!resp.ok) {
      if (errorBox) errorBox.textContent = 'Błąd dodawania odbiorcy.';
      return;
    }
    const data = await resp.json();
    if (!data.ok) {
      if (errorBox) errorBox.textContent = 'Błąd dodawania odbiorcy.';
      return;
    }

    input.value = '';
    if (errorBox) errorBox.textContent = '';
    await loadCustomers();
  } catch (e) {
    if (errorBox) errorBox.textContent = 'Błąd połączenia.';
  }
}

// ... (addProductForCustomer, deleteCustomerProductRow, deleteCustomer, doLogout – jak w Twoim pliku) ...

// --- zakładki (poza window.load) ---
document.addEventListener('click', e => {
  const btn = e.target.closest('.tab-btn');
  if (!btn) return;
  const tabId = btn.dataset.tab;

  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  document.querySelectorAll('.tab-panel').forEach(p => {
    p.classList.toggle('active', p.id === tabId);
  });
});

// --- init po załadowaniu ---
window.addEventListener('load', async () => {
  await loadMasterProducts();
  await loadSuppliers();
  recomputeLowestNetPrices();
  await loadCustomers();

  const btnAddCustomer = document.getElementById('addCustomerBtn');
  if (btnAddCustomer) btnAddCustomer.addEventListener('click', addCustomer);

  const btnAddSupplier = document.getElementById('addSupplierBtn');
  if (btnAddSupplier) btnAddSupplier.addEventListener('click', addSupplier);

  const btnReload = document.getElementById('reloadBtn');
  if (btnReload) {
    btnReload.addEventListener('click', async () => {
      await loadMasterProducts();
      await loadSuppliers();
      await loadCustomers();
    });
  }

  const btnLogout = document.getElementById('logoutBtn');
  if (btnLogout) btnLogout.addEventListener('click', doLogout);

  const searchInput = document.getElementById('productsSearch');
  if (searchInput) {
    searchInput.addEventListener('input', e => {
      const q = e.target.value.trim().toLowerCase();
      const rows = document.querySelectorAll('#productsTable tbody tr');
      rows.forEach(row => {
        const nameCell = row.querySelector('td');
        if (!nameCell) return;
        const text = nameCell.textContent.toLowerCase();
        row.style.display = text.includes(q) ? '' : 'none';
      });
    });
  }
});
</script>
</body>
</html>
