<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>v1.1 Lista produktów, dostawców i odbiorców</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
    :root {
      --color-background: #fcfcf9;
      --color-surface: #fffffd;
      --color-text: #13343b;
      --color-text-secondary: #626c71;
      --color-primary: #21808d;
      --color-primary-hover: #1d7480;
      --color-border: rgba(94, 82, 64, 0.2);
      --radius: 10px;
      --shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.07);
      --font: Inter, Geist, Arial, sans-serif;
      --space: 18px;
      --space-sm: 10px;
      --max-width: 1100px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--color-background);
      color: var(--color-text);
      font-family: var(--font);
      font-size: 16px;
      min-height: 100vh;
    }

    .container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--space);
    }

    h1 {
      margin-top: 0;
      font-size: 1.2rem;
      border-left: 4px solid var(--color-primary);
      padding-left: 10px;
    }

    h2 {
      font-size: 1rem;
      margin-top: var(--space);
      margin-bottom: var(--space-sm);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
    }

    .top-bar-buttons {
      display: flex;
      gap: 8px;
    }

    input, select, button {
      font-family: inherit;
      font-size: 0.95rem;
      padding: 7px 13px;
      border-radius: var(--radius);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      outline: none;
      transition: border-color .2s, background .2s;
    }

    input:focus,
    select:focus {
      border-color: var(--color-primary);
    }

    button.primary {
      background: var(--color-primary);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 500;
      padding-inline: 18px;
    }

    button.primary:hover {
      background: var(--color-primary-hover);
    }

    button.danger {
      background: #ff5555;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
    }

    button.danger:hover {
      background: #d1002a;
    }

    button.outline {
      background: var(--color-surface);
      color: var(--color-primary);
      border-color: var(--color-primary);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .info {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-sm);
    }

    .supplier-add {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: var(--space-sm);
      background: var(--color-surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: var(--space-sm);
    }

    .supplier-add input {
      flex: 1;
    }

    .supplier-card {
      background: var(--color-surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: var(--space);
      padding: var(--space-sm);
    }

    .supplier-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
    }

    .supplier-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .supplier-header-buttons {
      display: flex;
      gap: 6px;
    }

    .supplier-add-product {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .supplier-add-product input {
      min-width: 140px;
    }

    .supplier-add-product .prod-name,
    .supplier-add-product .cust-prod-name {
      min-width: 260px;
    }

    .supplier-add-product .btn-add-product,
    .supplier-add-product .btn-add-cust-product {
      flex: 0 0 auto;
    }

    .products-table-wrapper {
      overflow-x: auto;
    }

    .products-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--color-surface);
      table-layout: auto;
    }

    .products-table th,
    .products-table td {
      padding: 8px 10px;
      border: 1px solid var(--color-border);
      text-align: left;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .products-table th {
      background: #f5f7f8;
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    .products-table td.price-cell {
      text-align: right;
    }

    .products-table tr:nth-child(even) {
      background: #fafafa;
    }

    .products-table .tag-supplier {
      font-size: 0.8rem;
      color: var(--color-primary);
      margin-left: 4px;
    }

    .cell-cheapest {
      background: #d6f4e5;
      font-weight: 600;
    }

    #error {
      color: #d1002a;
      margin-top: 6px;
      font-size: 0.9rem;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tab-btn {
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      padding: 6px 14px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .tab-btn.active {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .products-search {
      margin-bottom: 8px;
    }

    .products-search input {
      width: 100%;
    }

    @media (max-width: 700px) {
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .supplier-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="top-bar">
    <h1>Lista produktów, dostawców i odbiorców</h1>
    <div class="top-bar-buttons">
      <button id="logoutBtn" class="outline">Wyloguj</button>
      <button id="reloadBtn" class="outline">Odśwież</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-products">Produkty</button>
    <button class="tab-btn" data-tab="tab-suppliers">Dostawcy</button>
    <button class="tab-btn" data-tab="tab-customers">Odbiorcy</button>
  </div>

  <!-- Produkty -->
  <div id="tab-products" class="tab-panel active">
    <h2>Lista produktów i porównanie cen</h2>
    <div class="products-search">
      <input type="text" id="productsSearch" placeholder="Wpisz nazwę produktu..." />
    </div>
    <p class="info">
      Porównaj ceny wszystkich produktów we wszystkich firmach. Najtańsza oferta jest podświetlona.
    </p>
    <div class="products-table-wrapper">
      <table id="productsTable" class="products-table">
        <thead>
          <tr id="productsHeaderRow">
            <th>Produkt</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Dostawcy -->
  <div id="tab-suppliers" class="tab-panel">
    <div class="supplier-add">
      <input type="text" id="newSupplierName" placeholder="Wpisz nazwę dostawcy..." />
      <button id="addSupplierBtn" class="primary">Dodaj dostawcę</button>
    </div>
    <p class="info">
      W cenniku dostawcy możesz skorygować VAT dla produktu, zmiana zaktualizuje stawkę tego produktu wszędzie.
    </p>
    <div id="suppliersContainer"></div>
    <div id="error" class="error"></div>
  </div>

  <!-- Odbiorcy -->
  <div id="tab-customers" class="tab-panel">
    <div class="supplier-add">
      <input type="text" id="newCustomerName" placeholder="Wpisz nazwę odbiorcy..." />
      <button id="addCustomerBtn" class="primary">Dodaj odbiorcę</button>
    </div>
    <p class="info">
      Cenniki odbiorców korzystają zawsze z najniższych dostępnych cen netto dla produktu.
    </p>
    <div id="customersContainer"></div>
  </div>
</div>

<script>
// --- konfiguracja API, pomocnicze funkcje, loadMasterProducts, recomputeLowestNetPrices,
// createSupplierCard, loadSuppliers, addSupplier, addProductForSupplier, deleteProductRow,
// deleteSupplier – zachowaj dokładnie tak jak w Twoim aktualnym pliku. [file:25]

// ---------- ODBIORCY (kluczowe fragmenty) ----------

function createCustomerCard(customer) {
  const card = document.createElement('div');
  card.className = 'supplier-card';
  card.dataset.type = 'customer';
  card.dataset.customerId = customer.id;

  const header = document.createElement('div');
  header.className = 'supplier-header';

  const nameEl = document.createElement('div');
  nameEl.className = 'supplier-name';
  nameEl.textContent = customer.name;

  const headerBtns = document.createElement('div');
  headerBtns.className = 'supplier-header-buttons';

  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'danger';
  deleteBtn.textContent = 'Usuń odbiorcę';
  deleteBtn.addEventListener('click', () => deleteCustomer(customer.id));

  headerBtns.appendChild(deleteBtn);
  header.appendChild(nameEl);
  header.appendChild(headerBtns);

  const addRow = document.createElement('div');
  addRow.className = 'supplier-add-product';

  const datalistId = `products-lowest-list-${customer.id}`;
  let optionsHtml = '';
  LOWESTPRICES.forEach((info, name) => {
    optionsHtml += `<option value="${name}"
                          data-unit="${info.unit}"
                          data-price="${info.price}">${name}</option>`;
  });

  addRow.innerHTML = `
    <input list="${datalistId}" class="cust-prod-name" placeholder="Wybierz produkt" />
    <datalist id="${datalistId}">${optionsHtml}</datalist>
    <select class="cust-prod-unit">
      <option value="szt">szt</option>
      <option value="kg">kg</option>
      <option value="l">l</option>
    </select>
    <input type="number" step="0.01" min="0" class="cust-price-net" placeholder="Cena netto" readonly />
    <button type="button" class="primary btn-add-cust-product">Dodaj produkt</button>
  `;

  const nameInput  = addRow.querySelector('.cust-prod-name');
  const unitSelect = addRow.querySelector('.cust-prod-unit');
  const priceInput = addRow.querySelector('.cust-price-net');

  nameInput.addEventListener('input', () => {
    const val = nameInput.value.trim();
    const entry = LOWESTPRICES.get(val);
    if (!entry) return;
    unitSelect.value = entry.unit || 'szt';
    priceInput.value = entry.price;
  });

  const addBtn = addRow.querySelector('.btn-add-cust-product');
  addBtn.addEventListener('click', () => addProductForCustomer(card, customer.id));

  const tableWrap = document.createElement('div');
  tableWrap.className = 'products-table-wrapper';

  const table = document.createElement('table');
  table.className = 'products-table';
  table.innerHTML = `
    <thead>
      <tr>
        <th>Produkt</th>
        <th>Jednostka</th>
        <th>Cena netto najniższa</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  `;

  const tbody = table.querySelector('tbody');
  if (Array.isArray(customer.products) && customer.products.length > 0) {
    for (const p of customer.products) {
      const entry = LOWESTPRICES.get(p.name) || { unit: p.unit, price: null };
      const tr = document.createElement('tr');
      tr.dataset.customerId = customer.id;
      tr.dataset.productId = p.productid;
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${entry.unit || p.unit}</td>
        <td class="price-cell">${entry.price != null ? formatPLN(entry.price) : '-'}</td>
        <td><button type="button" class="danger btn-del-cust-product">Usuń</button></td>
      `;
      tr.querySelector('.btn-del-cust-product')
        .addEventListener('click', () => deleteCustomerProductRow(tr));
      tbody.appendChild(tr);
    }
  } else {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="4">Brak produktów w cenniku odbiorcy.</td>';
    tbody.appendChild(tr);
  }

  tableWrap.appendChild(table);
  card.appendChild(header);
  card.appendChild(addRow);
  card.appendChild(tableWrap);

  return card;
}

async function loadCustomers() {
  const container = document.getElementById('customersContainer');
  container.innerHTML = '<p class="info">Ładowanie odbiorców...</p>';

  const csrf = getCsrfToken();
  try {
    const resp = await fetch(APICUSTOMERSURL, {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Accept': 'application/json',
        'X-CSRF-Token': csrf
      }
    });
    if (!resp.ok) {
      container.innerHTML = '<p class="info">Błąd ładowania odbiorców.</p>';
      return;
    }
    const data = await resp.json();
    container.innerHTML = '';
    if (!Array.isArray(data) || data.length === 0) {
      container.innerHTML = '<p class="info">Brak odbiorców.</p>';
      return;
    }
    for (const c of data) {
      const card = createCustomerCard(c);
      container.appendChild(card);
    }
    refreshAllDatalists();
  } catch (e) {
    container.innerHTML = '<p class="info">Błąd połączenia.</p>';
  }
}

async function addCustomer() {
  const input = document.getElementById('newCustomerName');
  const name = input.value.trim();
  const errorBox = document.getElementById('error');

  if (errorBox) errorBox.textContent = '';
  if (!name) {
    if (errorBox) errorBox.textContent = 'Podaj nazwę odbiorcy.';
    return;
  }

  const csrf = getCsrfToken();
  try {
    const resp = await fetch(APIADDCUSTOMER, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrf
      },
      body: JSON.stringify({ name })
    });
    if (!resp.ok) {
      if (errorBox) errorBox.textContent = 'Błąd dodawania odbiorcy.';
      return;
    }
    const data = await resp.json();
    if (!data.ok) {
      if (errorBox) errorBox.textContent = 'Błąd dodawania odbiorcy.';
      return;
    }

    input.value = '';
    if (errorBox) errorBox.textContent = '';
    await loadCustomers();
  } catch (e) {
    if (errorBox) errorBox.textContent = 'Błąd połączenia.';
  }
}

// ... (addProductForCustomer, deleteCustomerProductRow, deleteCustomer, doLogout – jak w Twoim pliku) ...

// --- zakładki (poza window.load) ---
document.addEventListener('click', e => {
  const btn = e.target.closest('.tab-btn');
  if (!btn) return;
  const tabId = btn.dataset.tab;

  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  document.querySelectorAll('.tab-panel').forEach(p => {
    p.classList.toggle('active', p.id === tabId);
  });
});

// --- init po załadowaniu ---
window.addEventListener('load', async () => {
  await loadMasterProducts();
  await loadSuppliers();
  recomputeLowestNetPrices();
  await loadCustomers();

  const btnAddCustomer = document.getElementById('addCustomerBtn');
  if (btnAddCustomer) btnAddCustomer.addEventListener('click', addCustomer);

  const btnAddSupplier = document.getElementById('addSupplierBtn');
  if (btnAddSupplier) btnAddSupplier.addEventListener('click', addSupplier);

  const btnReload = document.getElementById('reloadBtn');
  if (btnReload) {
    btnReload.addEventListener('click', async () => {
      await loadMasterProducts();
      await loadSuppliers();
      await loadCustomers();
    });
  }

  const btnLogout = document.getElementById('logoutBtn');
  if (btnLogout) btnLogout.addEventListener('click', doLogout);

  const searchInput = document.getElementById('productsSearch');
  if (searchInput) {
    searchInput.addEventListener('input', e => {
      const q = e.target.value.trim().toLowerCase();
      const rows = document.querySelectorAll('#productsTable tbody tr');
      rows.forEach(row => {
        const nameCell = row.querySelector('td');
        if (!nameCell) return;
        const text = nameCell.textContent.toLowerCase();
        row.style.display = text.includes(q) ? '' : 'none';
      });
    });
  }
});
</script>
</body>
</html>
